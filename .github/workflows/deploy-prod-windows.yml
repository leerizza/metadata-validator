name: Deploy to PROD (Windows Self-Hosted)

on:
  push:
    branches: ["main"]
    paths:
      - "deploy/**/*.sql"
      - ".github/workflows/deploy-prod-windows.yml"
  workflow_dispatch: {}

concurrency:
  group: deploy-prod
  cancel-in-progress: false

defaults:
  run:
    shell: cmd

jobs:
  deploy:
    runs-on: [self-hosted, Windows]
    environment: production
    steps:
      - uses: actions/checkout@v4

      # ambil path sqlcmd dari Actions Variable
      - name: Use sqlcmd path from repo variable
        run: |
          echo SQLCMD_EXE=${{ vars.SQLCMD_EXE }}>>%GITHUB_ENV%
          if not exist "${{ vars.SQLCMD_EXE }}" (
            echo sqlcmd.exe not found at: ${{ vars.SQLCMD_EXE }}
            exit /b 1
          )
          echo Using sqlcmd: %SQLCMD_EXE%

      - name: Tool check (sqlcmd)
        run: >
          powershell -NoProfile -ExecutionPolicy Bypass -Command
          "$ErrorActionPreference='Stop'; & $env:SQLCMD_EXE -? | Out-Null; Write-Host 'sqlcmd OK'"

      # ====== DEPLOY TANPA -Command (anti 'throw was unexpected') ======
      - name: Deploy to PROD (deploy\*.sql sorted)
        env:
          H: ${{ secrets.DB_HOST }}
          P: ${{ secrets.DB_PORT }}
          D: ${{ secrets.DB_NAME }}
          U: ${{ secrets.DB_USER }}
          W: ${{ secrets.DB_PASSWORD }}
        run: |
          >deploy-summary.md (
            echo ## PROD Deploy
            echo **Target:** %H%/%D%
            echo **Executed files:**
          )

          set "PORT=%P%"
          if "%PORT%"=="" set "PORT=1433"

          if exist deploy\*.sql (
            for %%F in (deploy\*.sql) do (
              echo - %%~nxF>>deploy-summary.md
              echo Executing %%~nxF ...
              "%SQLCMD_EXE%" -S %H%,%PORT% -d %D% -U %U% -P %W% -b -C -i "%%F"
              if errorlevel 1 (
                echo FAILED on %%~nxF
                exit /b 1
              )
            )
          ) else (
            echo _No SQL files in deploy/._>>deploy-summary.md
          )

      # ====== Tambahan ringkasan objek terbaru (tulis ps1 sementara) ======
      - name: Append recent objects (last 60m) to summary
        env:
          H: ${{ secrets.DB_HOST }}
          P: ${{ secrets.DB_PORT }}
          D: ${{ secrets.DB_NAME }}
          U: ${{ secrets.DB_USER }}
          W: ${{ secrets.DB_PASSWORD }}
        run: |
          set "PORT=%P%"
          if "%PORT%"=="" set "PORT=1433"

          set "SQL=SET NOCOUNT ON; SELECT TOP (50) s.name + '.' + t.name AS table_name, t.create_date, t.modify_date FROM sys.tables t JOIN sys.schemas s ON s.schema_id = t.schema_id WHERE t.create_date >= DATEADD(MINUTE, -60, SYSUTCDATETIME()) OR t.modify_date >= DATEADD(MINUTE, -60, SYSUTCDATETIME()) ORDER BY t.modify_date DESC, t.create_date DESC;"

          "%SQLCMD_EXE%" -S %H%,%PORT% -d %D% -U %U% -P %W% -b -C -h -1 -W -s " | " -Q "%SQL%" >> deploy-summary.md
          if errorlevel 1 (
            echo _(No recent changes or query failed)_>>deploy-summary.md
          )

      - name: Upload deploy summary
        uses: actions/upload-artifact@v4
        with:
          name: prod-deploy-summary
          path: deploy-summary.md
