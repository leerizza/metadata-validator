# SQL Validation Rules
# This file defines validation rules for SQL deployments

type_guards:
  create:
    enabled: true
    description: "Validation rules for CREATE statements"
    disallowed_patterns:
      - pattern: '\b(n?varchar|varbinary)\s*\(\s*max\s*\)'
        name: "MAX data types"
        message: "VARCHAR(MAX), NVARCHAR(MAX), and VARBINARY(MAX) are not allowed in CREATE statements"
        severity: error
        reason: "MAX types can cause performance issues and complicate indexing"
        examples:
          bad: "full_name VARCHAR(MAX)"
          good: "full_name NVARCHAR(500)"
      
      - pattern: '\b(text|ntext|image)\b'
        name: "Legacy data types"
        message: "TEXT, NTEXT, and IMAGE types are deprecated"
        severity: error
        reason: "These types are deprecated in modern SQL Server versions"
        examples:
          bad: "description TEXT"
          good: "description NVARCHAR(4000)"
      
      - pattern: '\bDROP\s+TABLE\b'
        name: "DROP TABLE in CREATE"
        message: "DROP TABLE statements are not allowed in CREATE scripts"
        severity: error
      
      - pattern: '\bTRUNCATE\s+TABLE\b'
        name: "TRUNCATE TABLE"
        message: "TRUNCATE TABLE can cause data loss"
        severity: error
      
      - pattern: '\bDROP\s+DATABASE\b'
        name: "DROP DATABASE"
        message: "DROP DATABASE is strictly prohibited"
        severity: error
  
  alter:
    enabled: true
    description: "Validation rules for ALTER statements"
    disallowed_patterns:
      - pattern: '\b(n?varchar|varbinary)\s*\(\s*max\s*\)'
        name: "MAX data types"
        message: "Cannot ALTER columns to VARCHAR(MAX), NVARCHAR(MAX), or VARBINARY(MAX)"
        severity: error
        reason: "MAX types can cause performance degradation on large tables"
        examples:
          bad: "ALTER COLUMN description VARCHAR(MAX)"
          good: "ALTER COLUMN description NVARCHAR(4000)"
      
      - pattern: '\b(text|ntext|image)\b'
        name: "Legacy data types"
        message: "Cannot ALTER columns to deprecated TEXT, NTEXT, or IMAGE types"
        severity: error
        reason: "Use VARCHAR(MAX), NVARCHAR(MAX), or VARBINARY(MAX) instead"
      
      - pattern: '\bDROP\s+COLUMN\b'
        name: "DROP COLUMN"
        message: "Dropping columns can cause data loss and break existing applications"
        severity: warning
        reason: "Consider deprecating the column first"
  
  drop:
    enabled: false
    description: "DROP statements are controlled by allowlist only"

naming_conventions:
  enabled: false  # Set to true to enable naming validation
  tables:
    pattern: '^[a-z][a-z0-9_]*$'
    message: "Table names should be lowercase with underscores (snake_case)"
    examples:
      bad: "UserTable, user-table, USERS"
      good: "user_table, users, customer_orders"
  
  columns:
    pattern: '^[A-Z][a-zA-Z0-9]*$'
    message: "Column names should be PascalCase"
    examples:
      bad: "user_name, USERNAME, user-name"
      good: "UserName, FirstName, CreatedAt"

# Performance optimization checks
performance_checks:
  enabled: false  # Set to true to enable performance warnings
  rules:
    - name: "SELECT * usage"
      pattern: '\bSELECT\s+\*\s+FROM'
      message: "SELECT * can impact performance, specify columns explicitly"
      severity: warning
    
    - name: "Missing indexes on foreign keys"
      pattern: '\bFOREIGN\s+KEY\b(?!.*\bINDEX\b)'
      message: "Consider adding indexes on foreign key columns"
      severity: warning
    
    - name: "NOLOCK hint"
      pattern: '\bWITH\s+\(\s*NOLOCK\s*\)'
      message: "NOLOCK can cause dirty reads, use READ UNCOMMITTED isolation level explicitly"
      severity: warning

# Security best practices
security_checks:
  enabled: false  # Set to true to enable security checks
  rules:
    - name: "Dynamic SQL"
      pattern: '\bEXEC\s*\(\s*@'
      message: "Dynamic SQL detected - ensure proper parameter validation to prevent SQL injection"
      severity: warning
    
    - name: "Missing WHERE in UPDATE/DELETE"
      pattern: '\b(UPDATE|DELETE)\b(?!.*\bWHERE\b)'
      message: "UPDATE/DELETE without WHERE clause will affect all rows"
      severity: error
    
    - name: "Weak permissions"
      pattern: '\bGRANT\s+(ALL|CONTROL)\b'
      message: "Avoid granting excessive permissions, use specific permissions instead"
      severity: warning
    
    - name: "SQL injection risk"
      pattern: '\bEXECUTE\s+\('
      message: "Ensure all dynamic SQL uses parameterized queries"
      severity: warning

# Data integrity checks
data_integrity:
  enabled: false  # Set to true to enable data integrity warnings
  rules:
    - name: "Missing primary key"
      pattern: '\bCREATE\s+TABLE\b(?!.*\bPRIMARY\s+KEY\b)'
      message: "Tables should have a PRIMARY KEY for data integrity"
      severity: warning
    
    - name: "Nullable foreign key"
      pattern: '\bFOREIGN\s+KEY.*?\bNULL\b'
      message: "Consider if foreign key columns should be nullable"
      severity: warning
    
    - name: "Missing constraints"
      pattern: '\bCREATE\s+TABLE\b(?!.*\b(CONSTRAINT|CHECK|DEFAULT)\b)'
      message: "Consider adding constraints (CHECK, DEFAULT, UNIQUE) for data validation"
      severity: warning

# Code quality checks
code_quality:
  enabled: false  # Set to true to enable code quality checks
  rules:
    - name: "Missing comments"
      pattern: '^(?!.*--).*\bCREATE\s+(PROCEDURE|FUNCTION)\b'
      message: "Stored procedures and functions should have documentation comments"
      severity: warning
    
    - name: "Hardcoded values"
      pattern: '(?<!\bDEFAULT\s)\b\d{4}-\d{2}-\d{2}\b'
      message: "Avoid hardcoded dates, use GETDATE() or parameters"
      severity: warning
    
    - name: "CURSOR usage"
      pattern: '\bDECLARE\s+\w+\s+CURSOR\b'
      message: "CURSORs can be slow, consider set-based operations"
      severity: warning

# Custom project-specific rules
custom_rules:
  enabled: false  # Set to true to enable custom rules
  rules:
    - name: "Audit columns"
      pattern: '\bCREATE\s+TABLE\b(?!.*\b(CreatedAt|CreatedBy|UpdatedAt|UpdatedBy)\b)'
      message: "Tables should include audit columns: CreatedAt, CreatedBy, UpdatedAt, UpdatedBy"
      severity: warning
    
    - name: "Soft delete"
      pattern: '\bCREATE\s+TABLE\b(?!.*\bIsDeleted\b)'
      message: "Consider adding IsDeleted column for soft delete pattern"
      severity: warning
    
    - name: "Schema prefix"
      pattern: '\bCREATE\s+(TABLE|PROCEDURE|FUNCTION|VIEW)\s+(?!dbo\.)'
      message: "Always specify schema prefix (e.g., dbo.TableName)"
      severity: warning

# Deployment safety checks
deployment_safety:
  enabled: true  # Always validate these critical patterns
  rules:
    - name: "Missing GO terminator"
      pattern: '.*'  # Always check at end of file
      message: "SQL file must end with GO statement"
      severity: error
    
    - name: "Multiple batches without GO"
      pattern: '\bCREATE\s+(PROCEDURE|FUNCTION|VIEW).*?\bCREATE\s+(PROCEDURE|FUNCTION|VIEW)'
      message: "Multiple CREATE statements should be separated by GO"
      severity: error
    
    - name: "USE database"
      pattern: '\bUSE\s+\['
      message: "Do not use USE [database] statement, connection string determines target database"
      severity: error