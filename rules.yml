# SQL Validation Rules (BFI Standard)
# Converted to match the PowerShell validator structure

type_guards:
  create:
    enabled: true
    description: "Validation rules for CREATE statements"
    rules:
      - pattern: '\b(n?varchar|varbinary)\s*\(\s*max\s*\)'
        name: "MAX data types"
        message: "VARCHAR(MAX), NVARCHAR(MAX), and VARBINARY(MAX) are not allowed in CREATE statements"
        severity: error
      - pattern: '\b(text|ntext|image)\b'
        name: "Legacy data types"
        message: "TEXT, NTEXT, and IMAGE types are deprecated"
        severity: error
      - pattern: '\bDROP\s+TABLE\s+(?!IF\s+EXISTS)(?!.*#)'
        name: "DROP TABLE without IF EXISTS"
        message: "Use 'DROP TABLE IF EXISTS' to avoid errors or data loss"
        severity: error
      - pattern: '\bTRUNCATE\s+TABLE\b'
        name: "TRUNCATE TABLE"
        message: "TRUNCATE TABLE can cause irreversible data loss"
        severity: error
      - pattern: '\bDROP\s+DATABASE\b'
        name: "DROP DATABASE"
        message: "DROP DATABASE is strictly prohibited"
        severity: error

  alter:
    enabled: true
    description: "Validation rules for ALTER statements"
    rules:
      - pattern: '\b(n?varchar|varbinary)\s*\(\s*max\s*\)'
        name: "MAX data types"
        message: "Cannot ALTER columns to VARCHAR(MAX), NVARCHAR(MAX), or VARBINARY(MAX)"
        severity: error
      - pattern: '\b(text|ntext|image)\b'
        name: "Legacy data types"
        message: "Cannot ALTER columns to deprecated TEXT, NTEXT, or IMAGE types"
        severity: error
      - pattern: '\bDROP\s+COLUMN\b'
        name: "DROP COLUMN"
        message: "Dropping columns may cause data loss — deprecate first"
        severity: warning
      - pattern: '\bALTER\s+COLUMN\s+\w+\s+\w+\s+NOT\s+NULL\b'
        name: "ALTER COLUMN to NOT NULL"
        message: "Ensure all existing data is non-NULL before applying NOT NULL"
        severity: warning

  procedure:
    enabled: true
    description: "Validation rules for stored procedures"
    rules:
      - pattern: '\bWITH\s+\(\s*NOLOCK\s*\)'
        name: "NOLOCK hint"
        message: "WITH (NOLOCK) can cause dirty reads and inconsistent results"
        severity: warning
      - pattern: '\bDROP\s+TABLE\s+(?!\s*IF\s+EXISTS)(?!DB_Temp\.\.)'
        name: "DROP TABLE in procedure"
        message: "Use 'DROP TABLE IF EXISTS' or drop temp tables only"
        severity: warning
      - pattern: '\bSELECT\s+.*\bINTO\s+(?!#|\@)(?!DB_Temp\.\.)'
        name: "SELECT INTO permanent table"
        message: "Use CREATE TABLE before SELECT INTO, or use temp tables (#table)"
        severity: warning
      - pattern: '\bCREATE\s+PROCEDURE\s+(?!\[?dbo\]?\.)'
        name: "Procedure without schema"
        message: "Always specify schema name, e.g., dbo.ProcName"
        severity: warning

performance_checks:
  enabled: true
  rules:
    - name: "SELECT * usage"
      pattern: '\bSELECT\s+\*\s+FROM'
      message: "SELECT * can impact performance, specify columns explicitly"
      severity: warning
    - name: "Missing indexes on foreign keys"
      pattern: '\bFOREIGN\s+KEY\b(?!.*\bINDEX\b)'
      message: "Consider adding indexes on foreign key columns"
      severity: warning
    - name: "Excessive NOLOCK usage"
      pattern: '(\bWITH\s+\(\s*NOLOCK\s*\).*?){5,}'
      message: "Excessive NOLOCK hints detected (5+ times)"
      severity: warning
    - name: "Nested views or functions"
      pattern: '\bCREATE\s+(VIEW|FUNCTION).*\bFROM.*\b(VIEW|FUNCTION)\b'
      message: "Nested views/functions can degrade performance"
      severity: warning

security_checks:
  enabled: true
  rules:
    - name: "Dynamic SQL"
      pattern: '\bEXEC\s*\(\s*@'
      message: "Dynamic SQL detected — ensure parameterization"
      severity: warning
    - name: "Missing WHERE in UPDATE/DELETE"
      pattern: '\b(UPDATE|DELETE)\s+(?!.*\bWHERE\b)'
      message: "UPDATE/DELETE without WHERE affects all rows"
      severity: error
    - name: "Weak permissions"
      pattern: '\bGRANT\s+(ALL|CONTROL)\b'
      message: "Avoid granting excessive permissions"
      severity: warning
    - name: "SQL injection risk"
      pattern: '\bEXECUTE\s*\('
      message: "Ensure dynamic SQL uses parameterized queries"
      severity: warning
    - name: "Hardcoded credentials"
      pattern: '(password|pwd|passwd)\s*=\s*[''"]'
      message: "Hardcoded credentials detected"
      severity: error

data_integrity:
  enabled: true
  rules:
    - name: "Missing primary key"
      pattern: '\bCREATE\s+TABLE\b(?!.*\bPRIMARY\s+KEY\b)'
      message: "Tables should have PRIMARY KEY"
      severity: warning
    - name: "Nullable foreign key"
      pattern: '\bFOREIGN\s+KEY.*?\bNULL\b'
      message: "Consider whether foreign keys should allow NULL"
      severity: warning
    - name: "Missing constraints"
      pattern: '\bCREATE\s+TABLE\b(?!.*\b(CONSTRAINT|CHECK|DEFAULT)\b)'
      message: "Add constraints for data validation"
      severity: warning
    - name: "ALTER COLUMN type change"
      pattern: '\bALTER\s+TABLE.*\bALTER\s+COLUMN\s+\w+\s+(VARCHAR|INT|DECIMAL|DATETIME)'
      message: "Changing data type may cause data loss"
      severity: warning

code_quality:
  enabled: true
  rules:
    - name: "Missing comments"
      pattern: '^(?!.*--).*\bCREATE\s+(PROCEDURE|FUNCTION)\b'
      message: "Procedures/functions should have comments"
      severity: warning
    - name: "Hardcoded dates"
      pattern: '(?<!\bDEFAULT\s)\b\d{4}-\d{2}-\d{2}\b'
      message: "Avoid hardcoded dates, use GETDATE() or parameters"
      severity: warning
    - name: "CURSOR usage"
      pattern: '\bDECLARE\s+\w+\s+CURSOR\b'
      message: "CURSORs are slow, use set-based operations"
      severity: warning
    - name: "Missing transaction handling"
      pattern: '\b(INSERT|UPDATE|DELETE)\b(?!.*\b(BEGIN\s+TRAN|COMMIT|ROLLBACK)\b)'
      message: "Consider wrapping DML in transactions"
      severity: warning
    - name: "Missing error handling"
      pattern: '\bCREATE\s+PROCEDURE\b(?!.*\b(TRY|CATCH|RAISERROR)\b)'
      message: "Add TRY/CATCH for error handling"
      severity: warning

custom_rules:
  enabled: true
  rules:
    - name: "Temp table in DB_Temp"
      pattern: '\b(SELECT|INSERT)\s+INTO\s+DB_Temp\.\.'
      message: "Ensure temp tables in DB_Temp are dropped at the end"
      severity: warning
    - name: "Cross-database query"
      pattern: '\bFROM\s+\w+\.\.\w+'
      message: "Cross-database query detected — verify permissions"
      severity: warning
    - name: "Missing audit columns"
      pattern: '\bCREATE\s+TABLE\b(?!.*\b(CreatedAt|CreatedBy|UpdatedAt|UpdatedBy)\b)'
      message: "Add audit columns (CreatedAt, CreatedBy, etc.)"
      severity: warning
    - name: "Soft delete column"
      pattern: '\bCREATE\s+TABLE\b(?!.*\bIsDeleted\b)'
      message: "Consider adding IsDeleted column for soft deletes"
      severity: warning
    - name: "Schema prefix"
      pattern: '\bCREATE\s+(TABLE|PROCEDURE|FUNCTION|VIEW)\s+(?!dbo\.|\[dbo\]\.)'
      message: "Always specify schema prefix (dbo.)"
      severity: warning
    - name: "Multiple DROP TABLE"
      pattern: '(\bDROP\s+TABLE.*?){3,}'
      message: "Multiple DROP TABLE detected — consolidate if possible"
      severity: warning

deployment_safety:
  enabled: true
  rules:
    - name: "Missing GO terminator"
      pattern: '.*'
      message: "SQL file must end with GO statement"
      severity: warning
    - name: "Multiple batches without GO"
      pattern: '\bCREATE\s+(PROCEDURE|FUNCTION|VIEW).*?\bCREATE\s+(PROCEDURE|FUNCTION|VIEW)'
      message: "Separate multiple CREATEs with GO"
      severity: warning
    - name: "USE database"
      pattern: '\bUSE\s+\['
      message: "Avoid USE [database]; use connection string"
      severity: warning
    - name: "SET options without GO"
      pattern: '\bSET\s+(ANSI_NULLS|QUOTED_IDENTIFIER)\s+(ON|OFF)(?!.*\bGO\b)'
      message: "SET options must be followed by GO"
      severity: warning

bfi_custom_rules:
  enabled: true
  rules:
    - name: "Stored procedure naming"
      pattern: '\bCREATE\s+PROCEDURE\s+(?!.*Usp_)'
      message: "Stored procedures should start with 'Usp_'"
      severity: warning
    - name: "Parameter data types"
      pattern: '@\w+\s+Varchar\s*\(\s*\d+\s*\)'
      message: "Use NVARCHAR instead of VARCHAR"
      severity: warning
    - name: "Date parameter handling"
      pattern: '@\w+(Date|Dt)\s+Varchar'
      message: "Date parameters should use DATE/DATETIME, not VARCHAR"
      severity: warning
    - name: "ROW_NUMBER without ORDER BY"
      pattern: '\bROW_NUMBER\s*\(\s*\)\s+OVER\s*\(\s*PARTITION'
      message: "ROW_NUMBER requires ORDER BY clause"
      severity: error
    - name: "FORMAT function usage"
      pattern: '\bFORMAT\s*\('
      message: "FORMAT can be slow; use CONVERT or CAST"
      severity: warning
    - name: "ISNULL vs COALESCE"
      pattern: '\bISNULL\s*\(\s*CASE'
      message: "Prefer COALESCE over ISNULL with CASE"
      severity: warning